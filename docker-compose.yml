version: '3.8'

services:
  db:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_USER: wink
      POSTGRES_PASSWORD: wink
      POSTGRES_DB: winkdb
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data

  backend:
    build: ./backend
    image: backend:dev
    restart: unless-stopped
    env_file: .env  # Используем .env для переменных окружения
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}
      - AI_PARSER_BASE_URL=${AI_PARSER_BASE_URL}
      - AI_SERVICE_URL=${AI_SERVICE_URL}
      - APP_STORAGE_UPLOAD_DIR=${APP_STORAGE_UPLOAD_DIR}
      - AI_PARSER_URL=${AI_PARSER_URL}
      - SCRIPT_PROCESSOR_BASE_URL=http://script-processor:8000
      - SCRIPT_PROCESSOR_MODEL=${SCRIPT_PROCESSOR_MODEL:-Qwen/Qwen3-32B}
      - APP_WORKFLOWS_DIR=${APP_WORKFLOWS_DIR:-/app/workflows}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      - OLLAMA_API_KEY=${OLLAMA_API_KEY:-}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen3:4b}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://$SERVER_IP:3000,http://localhost:5173,http://localhost:3000}  # Подставляем SERVER_IP

    depends_on:
      - db
      - ai
      - script-processor
    ports:
      - "8080:8080"
    volumes:
      - ./data/uploads:/data/uploads
      - ./ai-modules/workflows:/app/workflows
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  ai:
    build: ./ai-modules
    image: ai:dev
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - COMFY_BASE_URL=${COMFY_BASE_URL:-http://host.docker.internal:8188}
      - STORAGE_DIR=/data/frames
      - IMAGE_URL_BASE=http://localhost:8000/images
      - WORKFLOWS_DIR=/app/workflows
    volumes:
      - ./data/frames:/data/frames
      - ./ai-modules/workflows:/app/workflows:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"

  script-processor:
    build: ./script_processor
    image: script-processor:dev
    restart: unless-stopped
    ports:
      - "8020:8000"
    volumes:
      - ./script_processor/models:/app/models:ro
      - ./script_processor/chunks:/app/chunks

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=${VITE_API_BASE_URL:-/api}
        - VITE_COMFY_URL=${VITE_COMFY_URL:-/comfyui}
    image: frontend:dev
    restart: unless-stopped
    ports:
      - "3000:80"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  db_data:
