# ะะฝะฐะปะธะท ะฐััะธัะตะบัััั ะฟัะพะตะบัะฐ WINK-AI-PREVIZ

## ๐ ะัะฐัะบะพะต ะพะฟะธัะฐะฝะธะต ะฟัะพะตะบัะฐ

WINK-AI-PREVIZ โ ัะธััะตะผะฐ ะดะปั ะฐะฒัะพะผะฐัะธัะตัะบะพะน ะฒะธะทัะฐะปะธะทะฐัะธะธ ััะตะฝะฐัะธะตะฒ ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ LLM ะธ ะณะตะฝะตัะฐัะธะฒะฝัั ะผะพะดะตะปะตะน ะธะทะพะฑัะฐะถะตะฝะธะน.

### Pipeline ะพะฑัะฐะฑะพัะบะธ

```
1. ะะฐะณััะทะบะฐ ััะตะฝะฐัะธั (DOCX/PDF)
   โ
2. ะะฐะทะฑะธะตะฝะธะต ะฝะฐ ัะฐะฝะบะธ (script-processor)
   โ
3. ะะฐััะธะฝะณ ัะฐะฝะบะพะฒ โ JSON ััะตะฝ (LLM: Qwen3-32B / Mistral-7B)
   โ
4. ะะฑะพะณะฐัะตะฝะธะต JSON โ enriched JSON (LLM: Enhancer)
   โ
5. ะะพัััะพะตะฝะธะต ะฟัะพะผะฟัะฐ โ ัะตะบัั ะดะปั Flux (LLM: Prompt Builder)
   โ
6. ะะตะฝะตัะฐัะธั ะธะทะพะฑัะฐะถะตะฝะธั โ Flux Schnell
```

---

## ๐๏ธ ะขะตะบััะฐั ะฐััะธัะตะบัััะฐ

### ะะพะผะฟะพะฝะตะฝัั ัะธััะตะผั

#### 1. **Backend (Spring Boot 3.3.6, Java 21)**
- **ะัะฝะพะฒะฝะพะน ัะตัะฒะธั**: `PrevizService` โ ะพัะบะตัััะฐัะธั ะฒัะตะณะพ pipeline
- **ะะฐััะธะฝะณ ััะตะฝ**: 
  - `AiParserClient` โ ะพัะฝะพะฒะฝะพะน ะฟะฐััะตั ัะตัะตะท ะฒะฝะตัะฝะธะน AI ัะตัะฒะธั
  - `OllamaScriptParserService` โ fallback ัะตัะตะท Ollama
- **ะะตะฝะตัะฐัะธั ะฟัะพะผะฟัะพะฒ**:
  - `PromptCompilerClient` โ ััะฐััะน ัะฟะพัะพะฑ (ัะตัะตะท prompt-compiler ัะตัะฒะธั)
  - `SceneToFluxPromptService` โ ะฝะพะฒัะน pipeline (ัะตัะตะท Ollama, 2 ัะฐะณะฐ)
- **ะะตะฝะตัะฐัะธั ะธะทะพะฑัะฐะถะตะฝะธะน**: `AiImageClient` โ ะฒัะทะพะฒ Flux ัะตัะตะท ai-modules
- **ะฅัะฐะฝะตะฝะธะต**: PostgreSQL + JPA (Flyway ะผะธะณัะฐัะธะธ)

#### 2. **Frontend (React + Vite)**
- ะัะพััะพะน SPA ะดะปั ะทะฐะณััะทะบะธ ััะตะฝะฐัะธะตะฒ ะธ ะฟัะพัะผะพััะฐ ะบะฐะดัะพะฒ
- ะะพะผะฟะพะฝะตะฝัั: `MainPage`, `FrameViewer`

#### 3. **ะะฝะตัะฝะธะต ัะตัะฒะธัั (Python)**
- **script-processor**: ะะฐะทะฑะธะตะฝะธะต DOCX/PDF ะฝะฐ ัะฐะฝะบะธ
- **ai-modules**: ะะตะฝะตัะฐัะธั ะธะทะพะฑัะฐะถะตะฝะธะน ัะตัะตะท Flux Schnell
- **prompt-compiler**: ะกัะฐััะน ัะฟะพัะพะฑ ะบะพะผะฟะธะปััะธะธ ะฟัะพะผะฟัะพะฒ (Jinja2 ัะฐะฑะปะพะฝั)

#### 4. **LLM ะธะฝััะฐััััะบัััะฐ**
- **Ollama**: ะะพะบะฐะปัะฝัะน LLM ัะตัะฒะตั (Qwen3-32B, Mistral-7B)
- ะัะฟะพะปัะทัะตััั ะดะปั ะฟะฐััะธะฝะณะฐ, ะพะฑะพะณะฐัะตะฝะธั ะธ ะฟะพัััะพะตะฝะธั ะฟัะพะผะฟัะพะฒ

---

## ๐ ะะฝะฐะปะธะท ัะตะบััะตะน ัะตะฐะปะธะทะฐัะธะธ

### โ ะกะธะปัะฝัะต ััะพัะพะฝั

1. **ะะพะดัะปัะฝะฐั ะฐััะธัะตะบัััะฐ**: ะงะตัะบะพะต ัะฐะทะดะตะปะตะฝะธะต ะพัะฒะตัััะฒะตะฝะฝะพััะธ
2. **Fallback ะผะตัะฐะฝะธะทะผั**: Ollama ะบะฐะบ ัะตะทะตัะฒะฝัะน ะฟะฐััะตั
3. **ะัะธะฝััะพะฝะฝะฐั ะพะฑัะฐะฑะพัะบะฐ**: Background tasks ะดะปั ะฟะฐััะธะฝะณะฐ ััะตะฝะฐัะธะตะฒ
4. **ะขัะฐะฝะทะฐะบัะธะพะฝะฝะพััั**: ะัะฐะฒะธะปัะฝะพะต ะธัะฟะพะปัะทะพะฒะฐะฝะธะต `@Transactional`
5. **ะะธัััะฐะปัะฝัะต ะฟะพัะพะบะธ**: ะัะฟะพะปัะทะพะฒะฐะฝะธะต Java 21 virtual threads ะฒ `AiImageClient`

### โ๏ธ ะัะพะฑะปะตะผั ะธ ัะทะบะธะต ะผะตััะฐ

#### 1. **ะัะฑะปะธัะพะฒะฐะฝะธะต ะปะพะณะธะบะธ ะณะตะฝะตัะฐัะธะธ ะฟัะพะผะฟัะพะฒ**

**ะัะพะฑะปะตะผะฐ**: ะะฒะฐ ะฝะตะทะฐะฒะธัะธะผัั ัะฟะพัะพะฑะฐ ะณะตะฝะตัะฐัะธะธ ะฟัะพะผะฟัะพะฒ:
- `PromptCompilerClient` โ ััะฐััะน ัะฟะพัะพะฑ (ัะตัะตะท Python ัะตัะฒะธั)
- `SceneToFluxPromptService` โ ะฝะพะฒัะน pipeline (ัะตัะตะท Ollama)

**ะขะตะบััะตะต ะธัะฟะพะปัะทะพะฒะฐะฝะธะต**:
```java
// PrevizService.generateFrame() ะธัะฟะพะปัะทัะตั ััะฐััะน ัะฟะพัะพะฑ
String prompt = promptCompilerClient.compile(scene, level);
```

**ะะพะฒัะน pipeline** (`SceneToFluxPromptService`) ะดะพัััะฟะตะฝ ัะพะปัะบะพ ัะตัะตะท ะพัะดะตะปัะฝัะน endpoint `/api/visual/prompt`, ะฝะพ ะฝะต ะธะฝัะตะณัะธัะพะฒะฐะฝ ะฒ ะพัะฝะพะฒะฝะพะน ะฟัะพัะตัั ะณะตะฝะตัะฐัะธะธ ะบะฐะดัะพะฒ.

#### 2. **ะััััััะฒะธะต ัะพััะฐะฝะตะฝะธั enriched JSON**

**ะัะพะฑะปะตะผะฐ**: ะัะธ ะณะตะฝะตัะฐัะธะธ ะบะฐะดัะฐ ัะตัะตะท `generateFrame()`:
- ะะต ัะพััะฐะฝัะตััั enriched JSON
- ะะต ัะพััะฐะฝัะตััั ะฟัะพะผะตะถััะพัะฝัะน ัะตะทัะปััะฐั ะพะฑะพะณะฐัะตะฝะธั
- ะะตั ะฒะพะทะผะพะถะฝะพััะธ ะฟะพะฒัะพัะฝะพ ะธัะฟะพะปัะทะพะฒะฐัั enriched JSON ะดะปั ัะตะณะตะฝะตัะฐัะธะธ

**ะกััะตััะฒัััะฐั ัััะฝะพััั**: `SceneVisualEntity` ัะพะทะดะฐะฝะฐ ะดะปั ััะฐะฝะตะฝะธั enriched JSON, ะฝะพ ะฝะต ะธัะฟะพะปัะทัะตััั ะฒ ะพัะฝะพะฒะฝะพะผ flow.

#### 3. **ะกะธะฝััะพะฝะฝัะต ะฑะปะพะบะธััััะธะต ะฒัะทะพะฒั LLM**

**ะัะพะฑะปะตะผะฐ**: ะ `SceneToFluxPromptService`:
```java
String raw = ollamaClient.generateText(fullPrompt).block(); // ะฑะปะพะบะธััััะธะน ะฒัะทะพะฒ
```

ะญัะพ ะฑะปะพะบะธััะตั ะฟะพัะพะบ ะฒัะฟะพะปะฝะตะฝะธั, ะดะฐะถะต ะตัะปะธ ะธัะฟะพะปัะทัะตััั ะฒ async ะบะพะฝัะตะบััะต.

#### 4. **ะััััััะฒะธะต ะพะฑัะฐะฑะพัะบะธ ะพัะธะฑะพะบ ะธ retry**

**ะัะพะฑะปะตะผะฐ**: 
- ะะตั retry ะปะพะณะธะบะธ ะดะปั LLM ะฒัะทะพะฒะพะฒ
- ะะตั ะฒะฐะปะธะดะฐัะธะธ JSON ะฟะตัะตะด ัะพััะฐะฝะตะฝะธะตะผ
- ะะตั ะพะฑัะฐะฑะพัะบะธ ัะปััะฐะตะฒ, ะบะพะณะดะฐ LLM ะฒะพะทะฒัะฐัะฐะตั ะฝะตะฒะฐะปะธะดะฝัะน JSON

#### 5. **ะะตั ะบััะธัะพะฒะฐะฝะธั ะฟัะพะผะตะถััะพัะฝัั ัะตะทัะปััะฐัะพะฒ**

**ะัะพะฑะปะตะผะฐ**: 
- ะัะธ ัะตะณะตะฝะตัะฐัะธะธ ะบะฐะดัะฐ ั ัะตะผ ะถะต enriched JSON ะฟะพะฒัะพัะฝะพ ะฒัะทัะฒะฐะตััั LLM
- ะะตั ะบััะธัะพะฒะฐะฝะธั enriched JSON ะดะปั ะพะดะธะฝะฐะบะพะฒัั ััะตะฝ

#### 6. **ะะตะพะฟัะธะผะฐะปัะฝะฐั ััััะบัััะฐ ัะตัะฒะธัะพะฒ**

**ะัะพะฑะปะตะผะฐ**: 
- `SceneGenerationService` ะดัะฑะปะธััะตั ะปะพะณะธะบั ะธะท `PrevizService`
- ะะตั ัะตัะบะพะณะพ ัะฐะทะดะตะปะตะฝะธั ะผะตะถะดั orchestration ะธ domain logic

#### 7. **ะััััััะฒะธะต ะบะพะฝัะธะณััะธััะตะผะพััะธ ะผะพะดะตะปะตะน**

**ะัะพะฑะปะตะผะฐ**: 
- ะะพะดะตะปั ะดะปั Enhancer ะธ Prompt Builder ะทะฐัะฐัะดะบะพะถะตะฝะฐ ะฒ `OllamaClient`
- ะะตั ะฒะพะทะผะพะถะฝะพััะธ ะธัะฟะพะปัะทะพะฒะฐัั ัะฐะทะฝัะต ะผะพะดะตะปะธ ะดะปั ัะฐะทะฝัั ััะฐะฟะพะฒ

#### 8. **ะะตั ะฒะฐะปะธะดะฐัะธะธ enriched JSON**

**ะัะพะฑะปะตะผะฐ**: 
- ะัะพะฒะตัะบะฐ ัะพะปัะบะพ ะฝะฐ ะฒะฐะปะธะดะฝะพััั JSON, ะฝะพ ะฝะต ะฝะฐ ัะพะพัะฒะตัััะฒะธะต ััะตะผะต
- ะะตั ะฒะฐะปะธะดะฐัะธะธ ะพะฑัะทะฐัะตะปัะฝัั ะฟะพะปะตะน ะธะท `SceneVisualSpec_v1`

---

## ๐ฏ ะะตะบะพะผะตะฝะดะฐัะธะธ ะฟะพ ัะปัััะตะฝะธั ะฐััะธัะตะบัััั

### 1. **ะฃะฝะธัะธะบะฐัะธั pipeline ะณะตะฝะตัะฐัะธะธ ะฟัะพะผะฟัะพะฒ**

**ะฆะตะปั**: ะัะฟะพะปัะทะพะฒะฐัั ะตะดะธะฝัะน pipeline ะดะปั ะฒัะตั ัะปััะฐะตะฒ ะณะตะฝะตัะฐัะธะธ ะบะฐะดัะพะฒ.

**ะะตัะตะฝะธะต**:
- ะะฝัะตะณัะธัะพะฒะฐัั `SceneToFluxPromptService` ะฒ `PrevizService.generateFrame()`
- ะกะดะตะปะฐัั `PromptCompilerClient` ะพะฟัะธะพะฝะฐะปัะฝัะผ (legacy mode)
- ะะพะฑะฐะฒะธัั feature flag ะดะปั ะฟะตัะตะบะปััะตะฝะธั ะผะตะถะดั ััะฐััะผ ะธ ะฝะพะฒัะผ ัะฟะพัะพะฑะพะผ

**ะััะธัะตะบัััะฐ**:
```
PrevizService.generateFrame()
  โ
SceneToFluxPromptService.generateFromSceneJson()
  โ
  1. enhanceScene() โ enriched JSON
  2. buildFluxPrompt() โ Flux prompt
  โ
ะกะพััะฐะฝะธัั enriched JSON ะฒ SceneVisualEntity
  โ
AiImageClient.generate() โ ะธะทะพะฑัะฐะถะตะฝะธะต
```

### 2. **ะกะพััะฐะฝะตะฝะธะต enriched JSON ะฒ ะะ**

**ะฆะตะปั**: ะกะพััะฐะฝััั ะฟัะพะผะตะถััะพัะฝัะต ัะตะทัะปััะฐัั ะดะปั ะฟะพะฒัะพัะฝะพะณะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั.

**ะะตัะตะฝะธะต**:
- ะัะฟะพะปัะทะพะฒะฐัั `SceneVisualEntity` ะดะปั ััะฐะฝะตะฝะธั enriched JSON
- ะกะพััะฐะฝััั enriched JSON ะฟัะธ ะฟะตัะฒะพะน ะณะตะฝะตัะฐัะธะธ ะบะฐะดัะฐ
- ะัะฟะพะปัะทะพะฒะฐัั ัะพััะฐะฝะตะฝะฝัะน enriched JSON ะฟัะธ ัะตะณะตะฝะตัะฐัะธะธ (ะตัะปะธ ะฝะต ะธะทะผะตะฝะธะปะฐัั ััะตะฝะฐ)

**ะะทะผะตะฝะตะฝะธั**:
```java
@Transactional
public FrameDto generateFrame(String sceneIdStr, GenerateFrameRequest req) {
    Scene scene = sceneRepository.findById(sceneIdStr)...;
    
    // ะะพะปััะฐะตะผ ะธะปะธ ัะพะทะดะฐะตะผ enriched JSON
    SceneVisualEntity visual = sceneVisualRepository.findBySceneId(scene.getId())
        .orElseGet(() -> {
            // ะะตะฝะตัะธััะตะผ enriched JSON ัะพะปัะบะพ ะตัะปะธ ะตะณะพ ะฝะตั
            String baseJson = convertSceneToJson(scene);
            FluxPromptResult result = sceneToFluxPromptService.generateFromSceneJson(baseJson);
            
            SceneVisualEntity newVisual = new SceneVisualEntity();
            newVisual.setSceneId(scene.getId());
            newVisual.setEnrichedJson(result.enrichedJson());
            newVisual.setFluxPrompt(result.prompt());
            return sceneVisualRepository.save(newVisual);
        });
    
    // ะัะฟะพะปัะทัะตะผ ัะพััะฐะฝะตะฝะฝัะน ะฟัะพะผะฟั
    ImageResult image = aiImageClient.generate(visual.getFluxPrompt(), level);
    // ... ัะพััะฐะฝะตะฝะธะต Frame
}
```

### 3. **ะัะธะฝััะพะฝะฝะฐั ะพะฑัะฐะฑะพัะบะฐ LLM ะฒัะทะพะฒะพะฒ**

**ะฆะตะปั**: ะะต ะฑะปะพะบะธัะพะฒะฐัั ะฟะพัะพะบะธ ะฟัะธ ะพะถะธะดะฐะฝะธะธ ะพัะฒะตัะฐ ะพั LLM.

**ะะตัะตะฝะธะต**:
- ะัะฟะพะปัะทะพะฒะฐัั ัะตะฐะบัะธะฒะฝัะต ัะธะฟั (`Mono<String>`) ะฒะผะตััะพ ะฑะปะพะบะธััััะธั ะฒัะทะพะฒะพะฒ
- ะัะฟะพะปัะทะพะฒะฐัั `@Async` ะดะปั ัะพะฝะพะฒะพะน ะพะฑัะฐะฑะพัะบะธ
- ะะพะฑะฐะฒะธัั timeout ะธ retry ะปะพะณะธะบั

**ะัะธะผะตั**:
```java
@Service
public class SceneToFluxPromptService {
    
    @Async("llmTaskExecutor")
    public CompletableFuture<String> enhanceSceneAsync(String sceneJson) {
        String fullPrompt = enhancerSystemPrompt + "\n\nHere is the scene JSON:\n" + sceneJson;
        
        return ollamaClient.generateText(fullPrompt)
            .timeout(Duration.ofSeconds(60))
            .retryWhen(Retry.backoff(3, Duration.ofSeconds(2)))
            .map(this::cleanModelOutput)
            .map(this::validateJson)
            .toFuture();
    }
}
```

### 4. **ะะพะฑะฐะฒะปะตะฝะธะต retry ะธ ะฒะฐะปะธะดะฐัะธะธ**

**ะฆะตะปั**: ะฃะปัััะธัั ะฝะฐะดะตะถะฝะพััั pipeline.

**ะะตัะตะฝะธะต**:
- ะะพะฑะฐะฒะธัั retry ั exponential backoff ะดะปั LLM ะฒัะทะพะฒะพะฒ
- ะะฐะปะธะดะฐัะธั JSON ะฟะพ ััะตะผะต (ะธัะฟะพะปัะทะพะฒะฐัั JSON Schema ะธะปะธ ัััะฝัั ะฒะฐะปะธะดะฐัะธั)
- ะะฑัะฐะฑะพัะบะฐ ัะปััะฐะตะฒ ะฝะตะฒะฐะปะธะดะฝะพะณะพ JSON ั ะฟะพะฒัะพัะฝะพะน ะฟะพะฟััะบะพะน

**ะัะธะผะตั**:
```java
private String enhanceScene(String sceneJson) throws Exception {
    String fullPrompt = enhancerSystemPrompt + "\n\nHere is the scene JSON:\n" + sceneJson;
    
    return ollamaClient.generateText(fullPrompt)
        .retryWhen(Retry.backoff(3, Duration.ofSeconds(2))
            .filter(throwable -> throwable instanceof JsonProcessingException))
        .map(raw -> {
            String cleaned = cleanModelOutput(raw);
            validateEnrichedJson(cleaned); // ะฟัะพะฒะตัะบะฐ ััะตะผั
            return cleaned;
        })
        .block();
}

private void validateEnrichedJson(String json) {
    JsonNode root = mapper.readTree(json);
    // ะัะพะฒะตัะบะฐ ะพะฑัะทะฐัะตะปัะฝัั ะฟะพะปะตะน
    requireNonNull(root.path("scene_id").asText(), "scene_id is required");
    requireNonNull(root.path("location").get("norm"), "location.norm is required");
    // ... ะดััะณะธะต ะฟัะพะฒะตัะบะธ
}
```

### 5. **ะััะธัะพะฒะฐะฝะธะต ะฟัะพะผะตะถััะพัะฝัั ัะตะทัะปััะฐัะพะฒ**

**ะฆะตะปั**: ะะทะฑะตะถะฐัั ะฟะพะฒัะพัะฝัั ะฒัะทะพะฒะพะฒ LLM ะดะปั ะพะดะธะฝะฐะบะพะฒัั ะดะฐะฝะฝัั.

**ะะตัะตะฝะธะต**:
- ะัะฟะพะปัะทะพะฒะฐัั Spring Cache ะดะปั ะบััะธัะพะฒะฐะฝะธั enriched JSON
- ะะปัั ะบััะฐ: ััั ัะพะดะตัะถะธะผะพะณะพ ะฑะฐะทะพะฒะพะณะพ JSON ััะตะฝั
- TTL ะบััะฐ: ะฝะฐัััะฐะธะฒะฐะตะผัะน (ะฝะฐะฟัะธะผะตั, 24 ัะฐัะฐ)

**ะัะธะผะตั**:
```java
@Cacheable(value = "enrichedScenes", key = "#sceneJson.hashCode()")
public FluxPromptResult generateFromSceneJson(String sceneJson) {
    // ...
}
```

### 6. **ะะตัะฐะบัะพัะธะฝะณ ััััะบัััั ัะตัะฒะธัะพะฒ**

**ะฆะตะปั**: ะฃะปัััะธัั ัะฐะทะดะตะปะตะฝะธะต ะพัะฒะตัััะฒะตะฝะฝะพััะธ.

**ะัะตะดะปะฐะณะฐะตะผะฐั ััััะบัััะฐ**:
```
service/
  โโโ orchestration/
  โ   โโโ PrevizOrchestrationService  // ะฒััะพะบะพััะพะฒะฝะตะฒะฐั ะพัะบะตัััะฐัะธั
  โ   โโโ SceneProcessingPipeline     // pipeline ะพะฑัะฐะฑะพัะบะธ ััะตะฝ
  โโโ domain/
  โ   โโโ SceneParsingService        // ะฟะฐััะธะฝะณ ััะตะฝ
  โ   โโโ SceneEnrichmentService     // ะพะฑะพะณะฐัะตะฝะธะต JSON
  โ   โโโ PromptGenerationService    // ะณะตะฝะตัะฐัะธั ะฟัะพะผะฟัะพะฒ
  โ   โโโ ImageGenerationService     // ะณะตะฝะตัะฐัะธั ะธะทะพะฑัะฐะถะตะฝะธะน
  โโโ infrastructure/
      โโโ AiParserClient
      โโโ OllamaClient
      โโโ AiImageClient
```

### 7. **ะะพะฝัะธะณััะธััะตะผะพััั ะผะพะดะตะปะตะน**

**ะฆะตะปั**: ะะพะทะผะพะถะฝะพััั ะธัะฟะพะปัะทะพะฒะฐัั ัะฐะทะฝัะต ะผะพะดะตะปะธ ะดะปั ัะฐะทะฝัั ััะฐะฟะพะฒ.

**ะะตัะตะฝะธะต**:
- ะัะฝะตััะธ ะผะพะดะตะปะธ ะฒ ะบะพะฝัะธะณััะฐัะธั (`application.yml`)
- ะกะพะทะดะฐัั ะพัะดะตะปัะฝัะต ะบะปะธะตะฝัั ะดะปั ัะฐะทะฝัั ััะฐะฟะพะฒ ะธะปะธ ะฟะฐัะฐะผะตััะธะทะพะฒะฐัั ัััะตััะฒัััะธะน

**ะะพะฝัะธะณััะฐัะธั**:
```yaml
ollama:
  base-url: ${OLLAMA_BASE_URL}
  api-key: ${OLLAMA_API_KEY}
  models:
    parser: qwen3:32b
    enhancer: qwen3:32b
    prompt-builder: mistral-7b-instruct
```

### 8. **ะะฐะปะธะดะฐัะธั ะฟะพ ััะตะผะต**

**ะฆะตะปั**: ะะฐัะฐะฝัะธัะพะฒะฐัั ัะพะพัะฒะตัััะฒะธะต enriched JSON ัะฟะตัะธัะธะบะฐัะธะธ.

**ะะตัะตะฝะธะต**:
- ะัะฟะพะปัะทะพะฒะฐัั JSON Schema ะดะปั ะฒะฐะปะธะดะฐัะธะธ
- ะะปะธ ัะพะทะดะฐัั DTO ะบะปะฐััั ะดะปั enriched JSON ะธ ะธัะฟะพะปัะทะพะฒะฐัั Bean Validation

**ะัะธะผะตั ั DTO**:
```java
public record EnrichedSceneJson(
    @NotNull String sceneId,
    @NotNull EnrichedLocation location,
    @NotNull EnrichedTime time,
    @NotEmpty List<EnrichedCharacter> characters,
    // ...
) {
    public record EnrichedLocation(
        @NotNull String raw,
        @NotNull String norm,
        String description,
        List<String> environmentDetails
    ) {}
}
```

### 9. **ะะพะฝะธัะพัะธะฝะณ ะธ ะปะพะณะธัะพะฒะฐะฝะธะต**

**ะฆะตะปั**: ะััะปะตะถะธะฒะฐะฝะธะต ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ ะธ ะพัะธะฑะพะบ.

**ะะตัะตะฝะธะต**:
- ะะพะฑะฐะฒะธัั ะผะตััะธะบะธ (Micrometer) ะดะปั ะบะฐะถะดะพะณะพ ััะฐะฟะฐ pipeline
- ะะพะณะธัะพะฒะฐัั ะฒัะตะผั ะฒัะฟะพะปะฝะตะฝะธั ะบะฐะถะดะพะณะพ ัะฐะณะฐ
- ะะพะฑะฐะฒะธัั ััะตะนัะธะฝะณ (distributed tracing) ะดะปั ะพััะปะตะถะธะฒะฐะฝะธั ะทะฐะฟัะพัะพะฒ

**ะัะธะผะตั**:
```java
@Timed(value = "scene.enrichment", description = "Time to enrich scene JSON")
public String enhanceScene(String sceneJson) {
    Instant start = Instant.now();
    try {
        String result = // ... ะพะฑะพะณะฐัะตะฝะธะต
        log.info("Scene enriched in {}ms", Duration.between(start, Instant.now()).toMillis());
        return result;
    } catch (Exception e) {
        log.error("Failed to enrich scene", e);
        throw e;
    }
}
```

### 10. **ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ ะธ fallback ัััะฐัะตะณะธะธ**

**ะฆะตะปั**: ะฃะปัััะธัั ะพัะบะฐะทะพัััะพะนัะธะฒะพััั.

**ะะตัะตะฝะธะต**:
- ะะพะฑะฐะฒะธัั Circuit Breaker ะดะปั LLM ะฒัะทะพะฒะพะฒ
- Fallback ะฝะฐ ััะฐััะน ัะฟะพัะพะฑ ะณะตะฝะตัะฐัะธะธ ะฟัะพะผะฟัะพะฒ ะฟัะธ ะพัะธะฑะบะต
- Graceful degradation: ะฒะพะทะฒัะฐัะฐัั ัะฐััะธัะฝัะต ัะตะทัะปััะฐัั ะฟัะธ ะพัะธะฑะบะฐั

---

## ๐ ะัะตะดะปะฐะณะฐะตะผะฐั ะฐััะธัะตะบัััะฐ (ัะปัััะตะฝะฝะฐั)

### ะกะปะพะธ ะฟัะธะปะพะถะตะฝะธั

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    Presentation Layer                    โ
โ  Controllers (REST API)                                 โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
โโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                 Orchestration Layer                      โ
โ  PrevizOrchestrationService                             โ
โ  - ะะพะพัะดะธะฝะธััะตั ะฒะตัั pipeline                           โ
โ  - ะฃะฟัะฐะฒะปัะตั ััะฐะฝะทะฐะบัะธัะผะธ                               โ
โ  - ะะฑัะฐะฑะฐััะฒะฐะตั ะพัะธะฑะบะธ                                  โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
โโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   Domain Layer                          โ
โ  SceneParsingService      โ  SceneEnrichmentService     โ
โ  PromptGenerationService  โ  ImageGenerationService     โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
โโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              Infrastructure Layer                        โ
โ  OllamaClient  โ  AiParserClient  โ  AiImageClient      โ
โ  Cache         โ  Database         โ  File Storage       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะพัะพะบ ะดะฐะฝะฝัั (ัะปัััะตะฝะฝัะน)

```
1. Upload Script
   โ
2. Background Processing (async)
   โโโ Split to chunks (script-processor)
   โโโ Parse chunks โ JSON scenes (LLM)
   โโโ Save scenes to DB
   โ
3. Generate Frame (on-demand)
   โโโ Get or create enriched JSON (cached)
   โ   โโโ If not cached: LLM enhancement
   โ   โโโ Save to SceneVisualEntity
   โโโ Generate Flux prompt (cached)
   โ   โโโ If not cached: LLM prompt builder
   โโโ Generate image (Flux Schnell)
   โโโ Save Frame
```

---

## ๐ง ะะปะฐะฝ ะผะธะณัะฐัะธะธ

### ะญัะฐะฟ 1: ะะฝัะตะณัะฐัะธั ะฝะพะฒะพะณะพ pipeline
1. ะะฝัะตะณัะธัะพะฒะฐัั `SceneToFluxPromptService` ะฒ `PrevizService.generateFrame()`
2. ะะพะฑะฐะฒะธัั ัะพััะฐะฝะตะฝะธะต enriched JSON ะฒ `SceneVisualEntity`
3. ะะพะฑะฐะฒะธัั feature flag ะดะปั ะฟะตัะตะบะปััะตะฝะธั ะผะตะถะดั ััะฐััะผ/ะฝะพะฒัะผ ัะฟะพัะพะฑะพะผ

### ะญัะฐะฟ 2: ะฃะปัััะตะฝะธะต ะฝะฐะดะตะถะฝะพััะธ
1. ะะพะฑะฐะฒะธัั retry ะปะพะณะธะบั ะดะปั LLM ะฒัะทะพะฒะพะฒ
2. ะะพะฑะฐะฒะธัั ะฒะฐะปะธะดะฐัะธั enriched JSON
3. ะฃะปัััะธัั ะพะฑัะฐะฑะพัะบั ะพัะธะฑะพะบ

### ะญัะฐะฟ 3: ะะฟัะธะผะธะทะฐัะธั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ
1. ะะพะฑะฐะฒะธัั ะบััะธัะพะฒะฐะฝะธะต enriched JSON
2. ะกะดะตะปะฐัั LLM ะฒัะทะพะฒั ะฐัะธะฝััะพะฝะฝัะผะธ
3. ะะพะฑะฐะฒะธัั ะผะตััะธะบะธ ะธ ะผะพะฝะธัะพัะธะฝะณ

### ะญัะฐะฟ 4: ะะตัะฐะบัะพัะธะฝะณ
1. ะะฐะทะดะตะปะธัั ัะตัะฒะธัั ะฟะพ ัะปะพัะผ (orchestration/domain/infrastructure)
2. ะัะฝะตััะธ ะบะพะฝัะธะณััะฐัะธั ะผะพะดะตะปะตะน
3. ะะพะฑะฐะฒะธัั ัะตััั ะดะปั ะบะฐะถะดะพะณะพ ัะปะพั

---

## ๐ ะะตััะธะบะธ ะดะปั ะพััะปะตะถะธะฒะฐะฝะธั

1. **ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั**:
   - ะัะตะผั ะฟะฐััะธะฝะณะฐ ััะตะฝะฐัะธั
   - ะัะตะผั ะพะฑะพะณะฐัะตะฝะธั JSON
   - ะัะตะผั ะณะตะฝะตัะฐัะธะธ ะฟัะพะผะฟัะฐ
   - ะัะตะผั ะณะตะฝะตัะฐัะธะธ ะธะทะพะฑัะฐะถะตะฝะธั

2. **ะะฐะดะตะถะฝะพััั**:
   - ะัะพัะตะฝั ััะฟะตัะฝัั ะฟะฐััะธะฝะณะพะฒ
   - ะัะพัะตะฝั ััะฟะตัะฝัั ะพะฑะพะณะฐัะตะฝะธะน
   - ะะพะปะธัะตััะฒะพ retry ะดะปั LLM ะฒัะทะพะฒะพะฒ
   - ะัะพัะตะฝั ะฒะฐะปะธะดะฝัั enriched JSON

3. **ะัะฟะพะปัะทะพะฒะฐะฝะธะต ัะตััััะพะฒ**:
   - ะะพะปะธัะตััะฒะพ ะฒัะทะพะฒะพะฒ LLM
   - ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะบััะฐ (hit rate)
   - ะะฐะทะผะตั enriched JSON ะฒ ะะ

---

## ๐ ะะฐะบะปััะตะฝะธะต

ะขะตะบััะฐั ะฐััะธัะตะบัััะฐ ะฟัะพะตะบัะฐ ะธะผะตะตั ัะพัะพััั ะพัะฝะพะฒั, ะฝะพ ััะตะฑัะตั ัะปัััะตะฝะธะน ะฒ ัะปะตะดัััะธั ะพะฑะปะฐัััั:

1. **ะฃะฝะธัะธะบะฐัะธั pipeline** โ ะธัะฟะพะปัะทะพะฒะฐะฝะธะต ะตะดะธะฝะพะณะพ ัะฟะพัะพะฑะฐ ะณะตะฝะตัะฐัะธะธ ะฟัะพะผะฟัะพะฒ
2. **ะกะพััะฐะฝะตะฝะธะต ะฟัะพะผะตะถััะพัะฝัั ัะตะทัะปััะฐัะพะฒ** โ enriched JSON ะดะพะปะถะตะฝ ัะพััะฐะฝััััั
3. **ะัะธะฝััะพะฝะฝะพััั** โ ะฝะตะฑะปะพะบะธััััะธะต ะฒัะทะพะฒั LLM
4. **ะะฐะดะตะถะฝะพััั** โ retry, ะฒะฐะปะธะดะฐัะธั, ะพะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ
5. **ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั** โ ะบััะธัะพะฒะฐะฝะธะต, ะพะฟัะธะผะธะทะฐัะธั ะทะฐะฟัะพัะพะฒ
6. **ะะพะฝะธัะพัะธะฝะณ** โ ะผะตััะธะบะธ ะธ ะปะพะณะธัะพะฒะฐะฝะธะต

ะัะตะดะปะพะถะตะฝะฝัะต ะธะทะผะตะฝะตะฝะธั ะฟะพะทะฒะพะปัั ัะปัััะธัั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััั, ะฝะฐะดะตะถะฝะพััั ะธ ะฟะพะดะดะตัะถะธะฒะฐะตะผะพััั ัะธััะตะผั.

